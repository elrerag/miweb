


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.6">
    
    
      
        <title>muchoAmuchos - Java Full Stack Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.4b9ffd7b.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#relacion-de-muchos-a-muchos" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../../.." title="Java Full Stack Docs" class="md-header-nav__button md-logo" aria-label="Java Full Stack Docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Java Full Stack Docs
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              muchoAmuchos
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Java Full Stack Docs" class="md-nav__button md-logo" aria-label="Java Full Stack Docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Java Full Stack Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../repaso/teoria/poo/herencia/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelo-de-datos-sqlite" class="md-nav__link">
    Modelo de datos (SqLite)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ddl" class="md-nav__link">
    DDL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estructura-del-proyecto-maven-normal-18" class="md-nav__link">
    Estructura del proyecto (Maven - normal 1.8)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pomxml" class="md-nav__link">
    pom.xml
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clase-de-administracion-de-la-conexion-singlenton" class="md-nav__link">
    Clase de administraciÃ³n de la conexiÃ³n (Singlenton).
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#servicio-de-matricula" class="md-nav__link">
    Servicio de matrÃ­cula
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#daos" class="md-nav__link">
    DAOS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelo-una-tabla-en-la-bd-una-clase-en-java" class="md-nav__link">
    Modelo (una tabla en la BD una clase en Java...ðŸ—¡)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    TODO
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <hr />
<h1 id="relacion-de-muchos-a-muchos">RelaciÃ³n de muchos a muchos</h1>
<hr />
<p>Para el siguiente caso disponemos de dos tablas:</p>
<ul>
<li><code>Alumno</code></li>
<li><code>Curso</code></li>
</ul>
<p>Un alumno puede estar en varios cursos y un curso lo pueden tomar varios alumnos; nos encontramos entonces ante una relaciÃ³n de muchos a muchos, la que serÃ¡ solventada en el siguiente ejemplo:</p>
<p>Lo primero es identificar quÃ© servicios requerimos de esta aplicaciÃ³n, aunque partamos diseÃ±ando el modelo, lo principal es saber quÃ© es lo que si quiere obtener.</p>
<ul>
<li>
<p><strong>Obtener los alumnos que posee un curso</strong>: Esto nos puede servir para llevar informaciÃ³n del curso, como listar en una vista sus alumnos.</p>
</li>
<li>
<p><strong>Obtener los cursos que posee un alumno</strong>: Como es una relaciÃ³n de muchos a muchos, cada uno de los cursos tambiÃ©n puede obtener cero o muchos alumnos.</p>
</li>
<li>
<p><strong>Poder crear una matricula</strong>: Es decir que un alumno se inscriba en un curso aunque pertenezca a otro curso.</p>
</li>
</ul>
<p>Ahora ya podemos diseÃ±ar un modelo de datos para la soluciÃ³n.</p>
<h2 id="modelo-de-datos-sqlite">Modelo de datos (<code>SqLite</code>)</h2>
<p>Ya sabemos entonces que para solucionar el problema de la relaciÃ³n de muchos a muchos desde la base de datos, es por esto que se crea la tabla <code>alumno_curso</code>, el nombre estÃ¡ puesto asÃ­, solamente por orden alfabÃ©tico.</p>
<p><img src="https://github.com/elrerag/pintamiweb/blob/master/jfst/ejercicios/relaciones/001.png?raw=true" alt="relaciones001.png"></p>

<h2 id="ddl">DDL</h2>
<p>El cÃ³digo para preparar la base de datos es el siguiente (recordar crear el archivo en el proyecto).</p>
<p><strong>CreaciÃ³n de las tablas</strong></p>
<pre><code class="sql">DROP TABLE IF EXISTS alumno;
DROP TABLE IF EXISTS curso;
DROP TABLE IF EXISTS alumno_curso;


CREATE TABLE alumno(
    id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    nombre VARCHAR(200)
);

CREATE TABLE curso(
    id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    nombre VARCHAR(200)
);


CREATE TABLE alumno_curso(
    id_alumno INTEGER,
    id_curso INTEGER,
    PRIMARY KEY(id_alumno, id_curso),
    FOREIGN KEY(id_alumno) REFERENCES alumno(id),
    FOREIGN KEY(id_curso) REFERENCES curso(id)
);
</code></pre>

<p>PreparaciÃ³n de los datos de prueba</p>
<p>Se crean dos alumnos y 4 cursos, el primer alumno estarÃ¡ inscritos en los tres primeros cursos y el segundo alumno, solamente estarÃ¡ en el primer curso.</p>
<pre><code class="sql">INSERT INTO alumno (nombre) VALUES (&quot;Luis&quot;);
INSERT INTO alumno (nombre) VALUES (&quot;Ana&quot;);

INSERT INTO curso (nombre) VALUES (&quot;Curso de Java&quot;);
INSERT INTO curso (nombre) VALUES (&quot;Curso de Javascript&quot;);
INSERT INTO curso (nombre) VALUES (&quot;Curso de Base de Datos&quot;);
INSERT INTO curso (nombre) VALUES (&quot;Curso de Apresto&quot;);

INSERT INTO alumno_curso VALUES (1, 1);
INSERT INTO alumno_curso VALUES (1, 2);
INSERT INTO alumno_curso VALUES (1, 3);

INSERT INTO alumno_curso VALUES (2, 1);

-- Para eliminar la prueba de matrÃ­cula.
-- DELETE FROM alumno_curso WHERE id_alumno = 1 and id_curso = 4;
-- para probar:
select * from alumno;
select * from curso;
select * from alumno_curso;
</code></pre>

<h2 id="estructura-del-proyecto-maven-normal-18">Estructura del proyecto (Maven - normal 1.8)</h2>
<pre><code>./
â”œâ”€â”€ database.db
â”œâ”€â”€ pom.xml
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ main
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ java
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ cl
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ lherrera
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ relaciones
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ dao
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoCursoDAO.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoDAO.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ CursoDAO.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ ManejaConexion.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ main
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ Principal.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ modelo
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ Alumno.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoCurso.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ Curso.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ servicios
â”‚Â Â  â”‚Â Â  â”‚Â Â                  â””â”€â”€ ServicioMatricula.java
â”‚Â Â  â”‚Â Â  â””â”€â”€ resources
â”‚Â Â  â””â”€â”€ test
â”‚Â Â      â”œâ”€â”€ java
â”‚Â Â      â”‚Â Â  â””â”€â”€ cl
â”‚Â Â      â”‚Â Â      â””â”€â”€ lherrera
â”‚Â Â      â”‚Â Â          â””â”€â”€ relaciones
â”‚Â Â      â”‚Â Â              â””â”€â”€ servicios
â”‚Â Â      â”‚Â Â                  â””â”€â”€ ServicioMatriculaTest.java
â”‚Â Â      â””â”€â”€ resources
â””â”€â”€ target
    â”œâ”€â”€ classes
    â”‚Â Â  â”œâ”€â”€ META-INF
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ MANIFEST.MF
    â”‚Â Â  â”‚Â Â  â””â”€â”€ maven
    â”‚Â Â  â”‚Â Â      â””â”€â”€ cl.lherrera
    â”‚Â Â  â”‚Â Â          â””â”€â”€ relaciones
    â”‚Â Â  â”‚Â Â              â”œâ”€â”€ pom.properties
    â”‚Â Â  â”‚Â Â              â””â”€â”€ pom.xml
    â”‚Â Â  â””â”€â”€ cl
    â”‚Â Â      â””â”€â”€ lherrera
    â”‚Â Â          â””â”€â”€ relaciones
    â”‚Â Â              â”œâ”€â”€ dao
    â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoCursoDAO.class
    â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoDAO.class
    â”‚Â Â              â”‚Â Â  â”œâ”€â”€ CursoDAO.class
    â”‚Â Â              â”‚Â Â  â””â”€â”€ ManejaConexion.class
    â”‚Â Â              â”œâ”€â”€ main
    â”‚Â Â              â”‚Â Â  â””â”€â”€ Principal.class
    â”‚Â Â              â”œâ”€â”€ modelo
    â”‚Â Â              â”‚Â Â  â”œâ”€â”€ Alumno.class
    â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AlumnoCurso.class
    â”‚Â Â              â”‚Â Â  â””â”€â”€ Curso.class
    â”‚Â Â              â””â”€â”€ servicios
    â”‚Â Â                  â””â”€â”€ ServicioMatricula.class
    â””â”€â”€ test-classes
        â””â”€â”€ cl
            â””â”€â”€ lherrera
                â””â”€â”€ relaciones
                    â””â”€â”€ servicios
                        â””â”€â”€ ServicioMatriculaTest.class

36 directories, 25 files

</code></pre>

<h2 id="pomxml"><code>pom.xml</code></h2>
<p>Necesitamos las dependencias de JUnit5 y el <code>driver</code> de <code>SqLite</code>.</p>
<pre><code class="xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;cl.lherrera&lt;/groupId&gt;
    &lt;artifactId&gt;relaciones&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;

    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.mockito&lt;/groupId&gt;
            &lt;artifactId&gt;mockito-core&lt;/artifactId&gt;
            &lt;version&gt;2.28.2&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
            &lt;version&gt;5.6.0&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-engine --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
            &lt;version&gt;5.6.0&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- https://mvnrepository.com/artifact/org.junit.platform/junit-platform-launcher --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
            &lt;artifactId&gt;junit-platform-launcher&lt;/artifactId&gt;
            &lt;version&gt;1.6.0&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.xerial&lt;/groupId&gt;
            &lt;artifactId&gt;sqlite-jdbc&lt;/artifactId&gt;
            &lt;version&gt;3.30.1&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>

<h2 id="clase-de-administracion-de-la-conexion-singlenton">Clase de administraciÃ³n de la conexiÃ³n (<code>Singlenton</code>).</h2>
<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/dao/ManejaConexion.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.logging.Logger;


public class ManejaConexion {
    private static final String DB_URL = &quot;jdbc:sqlite:/Users/luisherrera/Desktop/TALENTO-PROS/servlets/relaciones/database.db&quot;;
    private static final Logger milog = Logger.getLogger(ManejaConexion.class.getName());

    private static ManejaConexion manejaConexion = new ManejaConexion();

    private ManejaConexion() {
        if (manejaConexion != null){
            //Prevent Reflection
            throw new IllegalStateException(&quot;No se puede crear una nueva instancia de ManejaConexion&quot;);
        }
    }

    public static ManejaConexion obtenerManejo() {
        return manejaConexion;
    }


    public Connection obtenerConexion() throws SQLException {
        Connection conexion = null;

        try {
            Class.forName(&quot;org.sqlite.JDBC&quot;);
            conexion = DriverManager.getConnection(DB_URL, &quot;admin&quot;, &quot;1234&quot;);

        } catch (ClassNotFoundException e) {
            milog.severe(&quot;No se pudo cargar el driver.&quot;);
            milog.severe(e.getMessage());
        }

        return conexion;
    }
}

</code></pre>

<h2 id="tests">Tests</h2>
<p>Se comienza entonces programando los test, para luego ejecutar el desarrollo hasta que los test funcionen.</p>
<p>Se probarÃ¡ solamente el servicio, ya que es lo que necesitamos. El test que matrÃ­cula realmente ingresa una matrÃ­cula, esto se soluciona con <code>spring</code>, por lo que no nos detenemos en intentar solucionar o volver la base de datos a lo que estaba, es solamente una prueba, por lo tanto es irrelevante.</p>
<p>Estos test, no funcionarÃ¡n desde un principio, asÃ­ practicamos TDD.</p>
<p><code>/relaciones/src/test/java/cl/lherrera/relaciones/servicios/ServicioMatriculaTest.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.servicios;

import static org.junit.jupiter.api.Assertions.assertTrue;

import java.beans.Transient;
import java.util.List;
import java.util.logging.Logger;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import cl.lherrera.relaciones.dao.AlumnoDAO;
import cl.lherrera.relaciones.dao.CursoDAO;
import cl.lherrera.relaciones.modelo.Alumno;
import cl.lherrera.relaciones.modelo.AlumnoCurso;
import cl.lherrera.relaciones.modelo.Curso;


@DisplayName(&quot;Pruebas del servicios&quot;)
public class ServicioMatriculaTest {
    Logger logger = Logger.getLogger(ServicioMatriculaTest.class.getName());

    private static Alumno alumno;
    private static Curso curso;
    private static AlumnoCurso alumnoCurso;

    private static ServicioMatricula servicio;

    @BeforeAll
    static void initAll() {
        alumno = (new AlumnoDAO()).obtenerAlumnoPorId(1L);
        curso = (new CursoDAO()).obtenerCursoPorId(1L);
        alumnoCurso = new AlumnoCurso(alumno, curso);

        servicio = new ServicioMatricula();
    }

    @BeforeEach
    void antesDeCada() {
        logger.warning(&quot;Nuevo test__________________________________-&quot;);
    }

    @Test
    @DisplayName(&quot;si el curso 1 tiene al menos un alumno&quot;)
    void alumnos_por_curso() {
        // obtengo los alumnos por curso
        List&lt;Alumno&gt; alumnos = servicio.obtenerAlumnosPorCurso(curso);
        // los listo
        alumnos.forEach(alumno -&gt; logger.info(alumno.toString() ) );
        // compruebo que al menos tenga uno, asÃ­ debe estar en la base

        assertTrue(alumnos.size() &gt; 0);
    }

    @Test
    @DisplayName(&quot;si el alumno 1 tiene al menos un curso&quot;)
    void cursos_por_alumno() {
        // obtengo los alumnos por curso
        List&lt;Curso&gt; cursos = servicio.obtenerCursosPorAlumno(alumno);
        // los listo
        cursos.forEach(curso -&gt; logger.info(curso.toString() ) );
        // compruebo que al menos tenga uno, asÃ­ debe estar en la base

        assertTrue(cursos.size() &gt; 0);
    }

    @Test
    @DisplayName(&quot;Probar si matricula&quot;)
    void hacerMatricula() {
        Curso cursoApresto = (new CursoDAO()).obtenerCursoPorId(4L);
        AlumnoCurso datosMatricula = new AlumnoCurso(alumno, cursoApresto);

        assert(servicio.hacerMatricula(datosMatricula));
    }
}

</code></pre>

<h2 id="servicio-de-matricula">Servicio de matrÃ­cula</h2>
<p>Esta es la lÃ³gica del negocio, en este caso quizÃ¡s se parezca mucho a lo que estÃ¡n haciendo los daos, pero el DAO se encarga sÃ³lo de los datos, no le importa el negocio, es por esto que se debe especializar una capa para este fin, de esta manera si existiera un controlador (no lo hay por que no hay vista).</p>
<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/servicios/ServicioMatricula.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.servicios;

import java.util.List;

import cl.lherrera.relaciones.dao.AlumnoCursoDAO;
import cl.lherrera.relaciones.modelo.Alumno;
import cl.lherrera.relaciones.modelo.AlumnoCurso;
import cl.lherrera.relaciones.modelo.Curso;

public class ServicioMatricula {
    private AlumnoCursoDAO daoAlumnoCurso = new AlumnoCursoDAO();

    public boolean hacerMatricula(AlumnoCurso alumnoCurso) {
        boolean retorno = false;
        int filasAfectadas = 0;
        if(alumnoCurso != null)
            filasAfectadas = daoAlumnoCurso.ingresaAlumnoCurso(alumnoCurso);
        if(filasAfectadas &gt; 0 )
            retorno = true;

        return retorno;
    }

    /**
     * No importa que por ahora esto parezca redundante, pero de esta
     * manera separamos la lÃ³gica de negocio de los accesos a los datos
     * la lÃ³gica de negocio puede cambiar, quizÃ¡s ya no importa que
     * tenga una lista de cursos, pero el curso debe seguir
     * retornando los objetos cursos, esto no puede cambiar
     * la lÃ³gica de negocio sÃ­.
     *  
     */
    public List&lt;Alumno&gt; obtenerAlumnosPorCurso(Curso curso) {
        return curso.obtenerAlumnos();
    }

    public List&lt;Curso&gt; obtenerCursosPorAlumno(Alumno alumno) {
        return alumno.obtenerCursos();
    }
}
</code></pre>

<h2 id="daos">DAOS</h2>
<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/dao/AlumnoCursoDAO.java</code></p>
<p>Si se involucran alumnos y cursos en una consulta, esto debe ir en este lugar.</p>
<pre><code class="java">package cl.lherrera.relaciones.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Logger;

import cl.lherrera.relaciones.modelo.Alumno;
import cl.lherrera.relaciones.modelo.AlumnoCurso;
import cl.lherrera.relaciones.modelo.Curso;

public class AlumnoCursoDAO {
    private static final ManejaConexion manejaConexion = ManejaConexion.obtenerManejo();
    Logger logger = Logger.getLogger(AlumnoCursoDAO.class.getName());

    public int ingresaAlumnoCurso(AlumnoCurso alumnoCurso) {
         int filasAfectadas = 0;
         Long idAlumno = alumnoCurso.getAlumno().getId();
         Long idCurso = alumnoCurso.getCurso().getId();

         String sqlQuery = &quot;INSERT INTO alumno_curso VALUES (?, ?)&quot;;

        try(
            Connection conexion = manejaConexion.obtenerConexion();
            PreparedStatement ps = conexion.prepareStatement(sqlQuery);
        ){
            ps.setLong(1, idAlumno);
            ps.setLong(2, idCurso);

            filasAfectadas = ps.executeUpdate();

            if(filasAfectadas != 1)
                throw new SQLException(&quot;Error al insertar registro&quot;);

        }catch (SQLException e) {
            logger.severe(e.getMessage());
        }

        return filasAfectadas;
    }

    /**
     * |alumno| &gt;-&lt; |curso| 
     * Trae todos los cursos por alumnos 
     */
    public List&lt;Alumno&gt; obtenerAlumnosPorCurso(Curso curso){
        List&lt;Alumno&gt; alumnos = new ArrayList&lt;&gt;();
        String sqlTxt = &quot;&quot;
        + &quot;SELECT a.id,                            &quot;
        + &quot;   a.nombre                             &quot;
        + &quot;FROM   alumno a                         &quot;
        + &quot;       INNER JOIN alumno_curso ac       &quot;
        + &quot;               ON a.id = ac.id_alumno   &quot;
        + &quot;                  AND ac.id_curso = &quot; + curso.getId();

        try(
            Connection conexion = manejaConexion.obtenerConexion();
            PreparedStatement ps = conexion.prepareStatement(sqlTxt);
            ResultSet rs = ps.executeQuery();
        ) {
            while(rs.next()) {
                alumnos.add(new Alumno(rs.getLong(&quot;id&quot;), rs.getString(&quot;nombre&quot;)) );
            }

        } catch (SQLException e) {
            logger.severe(&quot;No se pudieron obtener los alumnos para el curso: &quot; + curso.toString());
            logger.severe(e.getMessage());
        }

        return alumnos;
    }

    public List&lt;Curso&gt; obtenerCursosPorAlumno(Alumno alumno){
        List&lt;Curso&gt; cursos = new ArrayList&lt;&gt;();
        String sqlTxt = &quot;&quot;
        + &quot;SELECT c.id,                            &quot;
        + &quot;   c.nombre                             &quot;
        + &quot;FROM   curso c                          &quot;
        + &quot;       INNER JOIN alumno_curso ac       &quot;
        + &quot;               ON c.id = ac.id_curso    &quot;
        + &quot;                  AND ac.id_alumno = &quot; + alumno.getId();

        try(
            Connection conexion = manejaConexion.obtenerConexion();
            PreparedStatement ps = conexion.prepareStatement(sqlTxt);
            ResultSet rs = ps.executeQuery();
        ) {
            while(rs.next()) {
                cursos.add(new Curso(rs.getLong(&quot;id&quot;), rs.getString(&quot;nombre&quot;)) );
            }

        } catch (SQLException e) {
            logger.severe(&quot;No se pudieron obtener los cursos para el alumno: &quot; + alumno.toString());
            logger.severe(e.getMessage());
        }

        return cursos;
    }

}

</code></pre>

<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/dao/AlumnoDAO.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Logger;

import cl.lherrera.relaciones.modelo.Alumno;

public class AlumnoDAO {
    ManejaConexion manejoCon = ManejaConexion.obtenerManejo();
    Logger logger = Logger.getLogger(AlumnoDAO.class.getName());

    public Alumno obtenerAlumnoPorId(Long id) {
        Alumno alumno = new Alumno();
        String sqlTxt = &quot;select id, nombre from alumno where id = &quot; + id;

        try(
                Connection conn = manejoCon.obtenerConexion();
                PreparedStatement ps = conn.prepareStatement(sqlTxt);
                ResultSet rs = ps.executeQuery();
            ) {
                while(rs.next()) {
                    alumno.setId(rs.getLong(&quot;id&quot;));
                    alumno.setNombre(rs.getString(&quot;nombre&quot;));
                }

            } catch (SQLException e) {
                logger.severe(&quot;No se pudieron obtener los cursos para el alumno: &quot; + alumno.toString());
                logger.severe(e.getMessage());
            }
        return alumno;
    }
}
</code></pre>

<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/dao/CursoDAO.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Logger;

import cl.lherrera.relaciones.modelo.Curso;


public class CursoDAO {
    ManejaConexion manejoCon = ManejaConexion.obtenerManejo();
    Logger logger = Logger.getLogger(CursoDAO.class.getName());


    public Curso obtenerCursoPorId(Long id) {
        Curso curso = new Curso();
        String sqlTxt = &quot;select id, nombre from curso where id = &quot; + id;

        try(
                Connection conn = manejoCon.obtenerConexion();
                PreparedStatement ps = conn.prepareStatement(sqlTxt);
                ResultSet rs = ps.executeQuery();
            ) {
                while(rs.next()) {
                    curso.setId(rs.getLong(&quot;id&quot;));
                    curso.setNombre(rs.getString(&quot;nombre&quot;));
                }

            } catch (SQLException e) {
                logger.severe(
                    &quot;No se pudieron obtener los cursos para el alumno: &quot; 
                    + curso.toString()
                );

                logger.severe(e.getMessage());
            }
        return curso;
    }
}
</code></pre>

<h2 id="modelo-una-tabla-en-la-bd-una-clase-en-java">Modelo (una tabla en la BD una clase en Java...ðŸ—¡)</h2>
<p>Se permite la obtenciÃ³n de los datos asociados desde el mismo modelo, no directamente desde los atributos, pero sÃ­ un pequeÃ±o atajo.</p>
<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/modelo/Alumno.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.modelo;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

import cl.lherrera.relaciones.dao.AlumnoCursoDAO;


public class Alumno implements Serializable{
    private static final long serialVersionUID = 5780648523799074104L;

    private Long id;
    private String nombre;

    public Alumno() {}

    public Alumno(Long id, String nombre) {
        this.id = id;
        this.nombre = nombre;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getNombre() {
        return nombre;
    }

    public void setNombre(String nombre) {
        this.nombre = nombre;
    }

    @Override
    public String toString() {
        return &quot;Alumno [id=&quot; + id + &quot;, nombre=&quot; + nombre + &quot;]&quot;;
    }

    /**
     * Enlace con los cursos 
     */
    public List&lt;Curso&gt; obtenerCursos(){
        List&lt;Curso&gt; cursos = new ArrayList&lt;&gt;();
        if(this.id != null)
            cursos = (new AlumnoCursoDAO().obtenerCursosPorAlumno(this) );

        return cursos;
    }

}

</code></pre>

<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/modelo/Curso.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.modelo;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

import cl.lherrera.relaciones.dao.AlumnoCursoDAO;


public class Curso implements Serializable{

    private static final long serialVersionUID = 6037805339856868622L;

    private Long id;
    private String nombre;

    public Curso() {}

    public Curso(Long id, String nombre) {
        this.id = id;
        this.nombre = nombre;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getNombre() {
        return nombre;
    }

    public void setNombre(String nombre) {
        this.nombre = nombre;
    }

    @Override
    public String toString() {
        return &quot;Curso [id=&quot; + id + &quot;, nombre=&quot; + nombre + &quot;]&quot;;
    }

    /**
     * Enlace con los alumnos.
     */
    public List&lt;Alumno&gt; obtenerAlumnos(){
        List&lt;Alumno&gt; alumnos = new ArrayList&lt;&gt;();
        if(this.id != null)
            alumnos = (new AlumnoCursoDAO().obtenerAlumnosPorCurso(this) );

        return alumnos;
    }

}

</code></pre>

<p><code>/relaciones/src/main/java/cl/lherrera/relaciones/modelo/AlumnoCurso.java</code></p>
<pre><code class="java">package cl.lherrera.relaciones.modelo;

import java.io.Serializable;

public class AlumnoCurso implements Serializable{

    private static final long serialVersionUID = -1060964033872602317L;

    private Alumno alumno;
    private Curso curso;

    public AlumnoCurso() {}

    public AlumnoCurso(Alumno alumno, Curso curso) {
        this.alumno = alumno;
        this.curso = curso;
    }

    public Alumno getAlumno() {
        return alumno;
    }

    public void setAlumno(Alumno alumno) {
        this.alumno = alumno;
    }

    public Curso getCurso() {
        return curso;
    }

    public void setCurso(Curso curso) {
        this.curso = curso;
    }

}

</code></pre>

<p>Esto deberÃ­a ser suficiente, los test deberÃ­an funcionar una vez, luego fallarÃ­a el que inserta, solucionÃ¡ndolo, con ejecutar el delete incluido en el DDL. </p>
<h2 id="todo">TODO</h2>
<p>Como trabajo adicional, se puede crear el servicio que elimina la matrÃ­cula o crear esta soluciÃ³n WEB.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/vendor.a0c4167b.min.js"></script>
      <script src="../../../../assets/javascripts/bundle.fb26dd1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../../..",
          features: [],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>